// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Configurar zona horaria para Perú (UTC-5)
  // Agregar al final de tu DATABASE_URL: ?options=-c%20timezone=America/Lima
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  ADMIN
  PUERTA
  PRODUCCION
  FINANZAS
  TRABAJADOR
}

enum TipoPago {
  POR_HORA
  POR_PRODUCCION
}

enum EstadoAsistencia {
  PRESENTE
  TARDE
  AUSENTE
  JUSTIFICADO
}

enum TipoTransaccion {
  ADELANTO
  MULTA
  PAGO
  AJUSTE
}

enum TipoTrabajador {
  FIJO
  EVENTUAL
}

// ==========================================
// USUARIOS Y AUTENTICACIÓN
// ==========================================

model Usuario {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  nombre        String
  role          Role     @default(TRABAJADOR)
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relación con trabajador (si es un trabajador)
  trabajador    Trabajador?

  @@map("usuarios")
}

// ==========================================
// TRABAJADORES
// ==========================================

model Trabajador {
  id                String   @id @default(cuid())
  usuarioId         String   @unique
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  // Datos personales
  nombres           String
  apellidos         String
  dni               String   @unique
  telefono          String?
  direccion         String?
  fechaNacimiento   DateTime?
  fechaIngreso      DateTime @default(now())
  
  // Estado
  activo            Boolean  @default(true)
  cuentaBancaria    String?
  
  // NUEVO: Tipo de trabajador
  tipoTrabajador    TipoTrabajador @default(EVENTUAL)
  
  // NUEVO: Para trabajadores FIJOS
  jornadaId         String?
  jornada           Jornada?       @relation(fields: [jornadaId], references: [id])
  
  // Configuración salarial personalizada (opcional, si difiere de jornada)
  salarioBasePersonalizado          Decimal? @db.Decimal(10, 2)
  tarifaPorHoraPersonalizada        Decimal? @db.Decimal(10, 4)
  multiplicadorSuplPersonalizado    Decimal? @db.Decimal(10, 2)
  multiplicadorExtraPersonalizado   Decimal? @db.Decimal(10, 2)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  asistencias       Asistencia[]
  produccionDiaria  ProduccionDiaria[]
  transacciones     Transaccion[]
  pagos             Pago[]

  @@map("trabajadores")
}

// ==========================================
// ACTIVIDADES DE PRODUCCIÓN
// ==========================================

model Actividad {
  id                String      @id @default(cuid())
  codigo            String      @unique // TH, PR, MB, MM, MP, PB, PC, PP, PS
  nombre            String      @unique
  descripcion       String?
  tipoPago          TipoPago    // POR_HORA o POR_PRODUCCION
  valor             Decimal     @db.Decimal(10, 2) // tarifa por hora o por unidad
  unidadMedida      String?     // para POR_PRODUCCION: kg, cajas, unidades
  activo            Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relaciones
  produccionDiaria  ProduccionDiaria[]

  @@map("actividades")
}

// ==========================================
// JORNADAS LABORALES
// ==========================================

model Jornada {
  id                String     @id @default(cuid())
  nombre            String     // Ej: "Turno Mañana", "Turno Tarde"
  horaInicio        String     // Formato "HH:MM"
  horaFin           String     // Formato "HH:MM"
  
  // Días de la semana (0=Domingo, 1=Lunes, ..., 6=Sábado)
  // Si está vacío, se aplica a todos los días
  diasSemana        Int[]      // [1,2,3,4,5] para lunes a viernes
  
  // Fechas específicas (excepciones)
  fechaInicio       DateTime?  @db.Date  // Para jornadas excepcionales
  fechaFin          DateTime?  @db.Date  // Para rangos excepcionales
  
  esExcepcion       Boolean    @default(false) // Si es jornada excepcional
  activo            Boolean    @default(true)
  
  // NUEVO: Configuración salarial estandarizada
  salarioBaseMensual              Decimal    @default(433.33) @db.Decimal(10, 2)
  tarifaPorHora                   Decimal    @default(2.71) @db.Decimal(10, 4)
  multiplicadorHorasSuplementarias Decimal   @default(1.75) @db.Decimal(10, 2)
  multiplicadorHorasExtra         Decimal    @default(2.50) @db.Decimal(10, 2)
  horasDiariasBase                Decimal    @default(8.00) @db.Decimal(10, 2)
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  // NUEVO: Relación inversa
  trabajadores      Trabajador[]

  @@map("jornadas")
}

// ==========================================
// ASISTENCIAS (MÓDULO PUERTA)
// ==========================================

model Asistencia {
  id                String            @id @default(cuid())
  trabajadorId      String
  trabajador        Trabajador        @relation(fields: [trabajadorId], references: [id], onDelete: Cascade)
  
  fecha             DateTime          @default(now()) @db.Date
  
  // Turno programado para este día
  turnoProgramado   String?           // Ej: "08:00-16:00", "16:00-24:00", "00:00-08:00"
  
  horaEntrada       DateTime?
  horaSalida        DateTime?
  
  estado            EstadoAsistencia  @default(PRESENTE)
  minutosRetraso    Int               @default(0)
  
  // NUEVO: Campos calculados para trabajadores FIJOS
  horasTrabajadas         Decimal? @db.Decimal(10, 2) // Total de horas del día
  horasNormales           Decimal? @db.Decimal(10, 2) // Dentro de jornada
  horasSuplementarias     Decimal? @db.Decimal(10, 2) // Excedente días laborables
  horasExtra              Decimal? @db.Decimal(10, 2) // Excedente fines de semana
  montoCalculado          Decimal? @db.Decimal(10, 2) // Monto total del día
  
  // Justificaciones
  justificada                  Boolean  @default(false)
  motivoJustificacion          String?
  montoAjustePorJustificacion  Decimal? @db.Decimal(10, 2)  // Monto adicional recuperado por justificar
  
  // Registro
  registradoPor     String?           // ID del usuario que registró
  observaciones     String?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([trabajadorId, fecha])
  @@index([fecha])
  @@index([trabajadorId])
  @@map("asistencias")
}

// ==========================================
// PRODUCCIÓN DIARIA (MÓDULO PRODUCCIÓN)
// ==========================================

model ProduccionDiaria {
  id                String     @id @default(cuid())
  trabajadorId      String
  trabajador        Trabajador @relation(fields: [trabajadorId], references: [id], onDelete: Cascade)
  
  actividadId       String
  actividad         Actividad  @relation(fields: [actividadId], references: [id])
  
  fecha             DateTime   @default(now()) @db.Date
  
  // Según tipo de pago
  horasTrabajadas   Decimal?   @db.Decimal(10, 2)
  cantidadProducida Decimal?   @db.Decimal(10, 2)
  
  // Cálculo automático
  montoGenerado     Decimal    @default(0) @db.Decimal(10, 2)
  
  // Control
  horaInicio        DateTime?
  horaFin           DateTime?
  
  observaciones     String?
  registradoPor     String?    // ID del usuario que registró
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([fecha])
  @@index([trabajadorId])
  @@index([actividadId])
  @@map("produccion_diaria")
}

// ==========================================
// TRANSACCIONES FINANCIERAS
// ==========================================

model Transaccion {
  id                String           @id @default(cuid())
  trabajadorId      String
  trabajador        Trabajador       @relation(fields: [trabajadorId], references: [id], onDelete: Cascade)
  
  tipo              TipoTransaccion
  monto             Decimal          @db.Decimal(10, 2)
  concepto          String
  fecha             DateTime         @default(now())
  
  // Para adelantos y multas
  descontado        Boolean          @default(false)
  pagoId            String?          // Referencia al pago donde se descontó
  
  observaciones     String?
  registradoPor     String?          // ID del usuario que registró
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([trabajadorId])
  @@index([fecha])
  @@index([tipo])
  @@map("transacciones")
}

// ==========================================
// PAGOS SEMANALES (MÓDULO FINANZAS)
// ==========================================

model Pago {
  id                String          @id @default(cuid())
  trabajadorId      String
  trabajador        Trabajador      @relation(fields: [trabajadorId], references: [id], onDelete: Cascade)
  
  // Período del pago
  fechaInicio       DateTime        @db.Date
  fechaFin          DateTime        @db.Date
  
  // Tipo de trabajador (crítico para cálculos)
  tipoTrabajador    TipoTrabajador  @default(EVENTUAL)
  
  // ============================================
  // CAMPOS PARA TRABAJADORES EVENTUALES
  // ============================================
  totalHoras        Decimal         @default(0) @db.Decimal(10, 2)
  totalProduccion   Decimal         @default(0) @db.Decimal(10, 2)
  montoBase         Decimal         @default(0) @db.Decimal(10, 2) // Total producción
  
  // ============================================
  // CAMPOS PARA TRABAJADORES FIJOS
  // ============================================
  salarioBasePeriodo          Decimal? @db.Decimal(10, 2) // Salario base del periodo (quincenal/mensual)
  
  // Desglose de horas trabajadas
  horasNormales               Decimal? @db.Decimal(10, 2)
  horasSuplementarias         Decimal? @db.Decimal(10, 2)
  horasExtra                  Decimal? @db.Decimal(10, 2)
  
  // Montos por tipo de hora
  montoHorasNormales          Decimal? @db.Decimal(10, 2)
  montoHorasSuplementarias    Decimal? @db.Decimal(10, 2)
  montoHorasExtra             Decimal? @db.Decimal(10, 2)
  
  sueldoTrabajado             Decimal? @db.Decimal(10, 2) // Suma de montos de horas
  
  // Descuentos automáticos por retardos/faltas (calculados en asistencias)
  totalDescuentos             Decimal  @default(0) @db.Decimal(10, 2)
  
  // Bonificación para alcanzar salario base
  // Fórmula: salarioBasePeriodo - sueldoTrabajado (si positivo)
  bonificacion                Decimal  @default(0) @db.Decimal(10, 2) // Aplicada (puede ser editada)
  bonificacionCalculada       Decimal? @db.Decimal(10, 2) // Auto-calculada (referencia)
  conceptoBonificacion        String?  // Justificación si es editada manualmente
  
  // ============================================
  // DESCUENTOS Y AJUSTES (AMBOS TIPOS)
  // ============================================
  adelantos         Decimal    @default(0) @db.Decimal(10, 2) // Transacciones tipo ADELANTO
  multasTransacciones Decimal  @default(0) @db.Decimal(10, 2) // Transacciones tipo MULTA (manual)
  ajustes           Decimal    @default(0) @db.Decimal(10, 2) // Transacciones tipo AJUSTE
  
  // ============================================
  // TOTALES
  // ============================================
  // FIJOS: salarioBase + bonificacion - adelantos - multas + ajustes - descuentos
  // EVENTUALES: montoBase - adelantos - multas + ajustes
  totalNeto         Decimal    @default(0) @db.Decimal(10, 2)
  
  // Estado de pago (soporta pagos parciales)
  montoPagado       Decimal    @default(0) @db.Decimal(10, 2)
  saldoPendiente    Decimal    @default(0) @db.Decimal(10, 2)
  pagado            Boolean    @default(false) // true cuando saldoPendiente = 0
  
  observaciones     String?
  generadoPor       String?    // ID del usuario que generó el pago
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relación con abonos
  abonos            Abono[]

  @@unique([trabajadorId, fechaInicio, fechaFin]) // Evitar nóminas duplicadas
  @@index([trabajadorId])
  @@index([fechaInicio, fechaFin])
  @@index([tipoTrabajador])
  @@map("pagos")
}

// ==========================================
// ABONOS (PAGOS PARCIALES)
// ==========================================

model Abono {
  id                String     @id @default(cuid())
  pagoId            String
  pago              Pago       @relation(fields: [pagoId], references: [id], onDelete: Cascade)
  
  monto             Decimal    @db.Decimal(10, 2)
  metodoPago        String     // Efectivo, Transferencia, Cheque, etc.
  numeroReferencia  String?    // Número de cheque, referencia de transferencia, etc.
  
  fecha             DateTime   @default(now())
  observaciones     String?
  registradoPor     String?    // ID del usuario que registró el abono
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([pagoId])
  @@index([fecha])
  @@map("abonos")
}
